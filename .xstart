#!/bin/bash
#
#   Xstart file -- to be launched by xsession or xinitrc
#   Man page: Xsession
#
#   TODO: This file really need some cleaning up!
#
# 
# https://wiki.archlinux.org/index.php/ConsoleKit

dbuslaunch="`which dbus-launch 2>/dev/null`"
if [ -n "$dbuslaunch" ] && [ -x "$dbuslaunch" ] && [ -z "$DBUS_SESSION_BUS_ADDRESS" ]; then
    eval `$dbuslaunch --sh-syntax --exit-with-session`
fi

if [ -f $HOME/.xmodmap ]; then
    if [ $(which xmodmap) ]; then
        xmodmap $HOME/.xmodmap
    else
        xmessage "warning: xmodmap not found"
    fi
fi

if  [ $(which xbindkeys) ]; then
    [ $(pidof xbindkeys) ]  || xbindkeys &
else
    xmessage "Warning: xbindkeys is not found"
fi

[ -f "${HOME}/.bin/home-fix" ] && ${HOME}/.bin/home-fix

wm_selection() {
    avail_vms=""
    for candidate in xmonad wmii pekwm awesome xfce4-session gnome-session openbox blackbox startfluxbox; do
        which $candidate && avail_vms="$avail_vms $candidate"
    done

    if [ $(which zenity) ]; then
        WM=$( zenity --list --title "ACTION?!?" --text "re-launch vm?" --column "Available window managers" $avail_vms )
    else
        xmessage "warning: zenity not found, no window manager selection possible"
    fi
}

[ -f "${HOME}/.Xresources" ] && xrdb -merge "${HOME}/.Xresources"
[ -f "${HOME}/.gtkrc-2.0" ] && export GTK2_RC_FILES="${HOME}/.gtkrc-2.0"
[ $(which gnome-settings-daemon) ] && pidof gnome-settings-daemon >/dev/null || gnome-settings-daemon &

if [ $(which gconftool-2) ]; then
    # disable gnome services
    gconftool-2 -t bool -s /apps/nautilus/preferences/show_desktop false
    gconftool-2 -t bool -s /desktop/gnome/volume_manager/automount_drives false
    gconftool-2 -t bool -s /apps/gnome_settings_daemon/screensaver/start_screensaver false
    gconftool-2 -t bool -s /apps/gnome-keyring/daemon-components/ssh false
    gconftool-2 -t bool -s /desktop/gnome/background/draw_background false
    gconftool-2 -t bool -s /apps/gnome_settings_daemon/plugins/background/active false
    gconftool-2 -t bool -s /apps/gnome_settings_daemon/plugins/ubuntuone/active false
    # unbind mod4-p that collides with my xmonad launcher
    gconftool-2 -t bool -s /apps/gnome_settings_daemon/plugins/xrandr/active false
fi

[ -x ~/.dropbox-dist/dropboxd ] && ~/.dropbox-dist/dropboxd &

[ $(which nm-applet) ] && pidof nm-applet >/dev/null || nm-applet --sm-disable &

BGCOL="#"
for C in $(echo "10 20 30" | sed 's/ /\n/g' | sort -R); do
    BGCOL="$BGCOL$C";
done

if [ $(which xsetroot) ]; then
    xsetroot -solid $BGCOL
    xsetroot -cursor_name left_ptr
else
    xmessage "warning: xsetroot not found"
fi

if [ $(which google-chrome) ]; then
    BROWSER=`which google-chrome`
    export BROWSER
elif [ $(which midori) ]; then
    BROWSER=`which midori`
    export BROWSER
elif [ $(which firefox) ]; then
    BROWSER=`which firefox`
    export BROWSER
fi

[ -f "${HOME}/.bashrc" ] && source "${HOME}/.bashrc"
keys_agent_start

WM=""
if [ $(which xmonad) ]; then
    WM="xmonad"
else
    wm_selection
fi

[ "z" = "z$WM" ] && xmessage "!!! No window manager found/selected !!!"

# Start the window manager
while [ ! "" = "$WM" ]; do
    ${WM}
    wm_selection
done
